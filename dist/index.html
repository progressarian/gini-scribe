<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>100ers ‚Äî Functional Aging Score</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --green:#2c6e49; --green-700:#1f4d34; --bg:#f4f7f9; --card:#fff; --text:#23323a;
    --pill:#e9eef1; --border:#d4dee5; --muted:#6a7a84; --accent:#dfe9ee;
    --good:#2c6e49; --ok:#65a665; --mid:#a9c9a9; --low:#e0b9b9; --bad:#d66a6a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--text)}

  /* Header / brand (bigger logo) */
  .brand{
    display:inline-flex;align-items:center;
    margin:12px 16px 0;text-decoration:none
  }
  .brand img{
    height:48px; /* was 28 ‚Äî make it prominent */
    width:auto; display:block
  }
  @media (min-width:768px){
    .brand img{ height:56px; }
  }

  .wrap{max-width:920px;margin:28px auto;padding:0 14px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.06);padding:24px}
  h1{margin:0 0 10px;font-size:34px;color:var(--green)}
  .muted{color:var(--muted)}
  .section{margin-top:14px}
  .grid{display:grid;gap:12px}
  label{font-weight:600}
  input[type="text"],input[type="email"],input[type="number"],select{
    width:100%;max-width:420px;padding:12px;border:1px solid var(--border);border-radius:10px;font-size:16px;background:#fff
  }
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
  .actions{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap}
  button{background:var(--green);color:#fff;border:0;border-radius:10px;padding:12px 18px;font-size:16px;cursor:pointer}
  button:hover{background:var(--green-700)}
  button.ghost{background:#fff;color:var(--green);border:1px solid var(--green)}
  .hide{display:none}
  .progress{position:sticky;top:0;background:#fff;border:1px solid var(--border);border-radius:999px;height:10px;overflow:hidden;margin:8px 0 18px}
  .bar{height:100%;background:var(--green);width:0%}
  .qwrap{min-height:180px}
  .qtitle{font-size:20px;font-weight:700;margin:6px 0 8px}
  .qhint{font-size:14px;color:var(--muted);margin-bottom:10px}
  .pillrow{display:flex;flex-wrap:wrap;gap:8px}
  .pill{
    padding:8px 12px;border-radius:999px;background:var(--pill);border:1px solid var(--border);
    cursor:pointer;user-select:none;font-size:14px
  }
  .pill[data-val="1"][data-selected="true"]{background:var(--bad);color:#fff;border-color:var(--bad)}
  .pill[data-val="2"][data-selected="true"]{background:var(--low);color:#fff;border-color:var(--low)}
  .pill[data-val="3"][data-selected="true"]{background:var(--mid);color:#fff;border-color:var(--mid)}
  .pill[data-val="4"][data-selected="true"]{background:var(--ok);color:#fff;border-color:var(--ok)}
  .pill[data-val="5"][data-selected="true"]{background:var(--good);color:#fff;border-color:var(--good)}
  .result{margin-top:16px;padding:16px;border:1px solid var(--accent);background:#eef7f1;border-radius:12px}
  .result h2{margin:4px 0 8px}
  .kpi{display:flex;gap:20px;flex-wrap:wrap;margin:8px 0}
  .kpi .box{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px 14px;min-width:180px}
  .bars{display:grid;gap:8px;margin:12px 0}
  .barrow{display:flex;align-items:center;gap:10px}
  .barlabel{width:120px;font-weight:600}
  .barfill{flex:1;height:12px;background:#e9f1ec;border-radius:8px;overflow:hidden}
  .barfill > span{display:block;height:100%;background:var(--green)}
  .cta{margin-top:12px;padding:14px;border:1px dashed var(--green);border-radius:12px;background:#f7fbf8}
  .small{font-size:13px;color:#4c5b63}

  /* Booking modal spacing tune-up you added */
  form input, form textarea, form select{ margin-bottom:12px; padding:10px; box-sizing:border-box }
  form .two-column{ display:flex; gap:12px }
  form .two-column input{ flex:1 }
  form textarea{ min-height:80px; resize:vertical }

  /* lightweight modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:20}
  .modal.show{display:flex}
  .dialog{background:#fff;border:1px solid var(--border);border-radius:14px;max-width:560px;width:100%;padding:16px}
  .x{cursor:pointer;font-size:20px;color:var(--muted)}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
</style>
</head>
<body>

<!-- Logo linking back to home (now sized by CSS, not inline style) -->
<a href="https://www.100ers.com" style="display: block; text-align: center; margin-bottom: 20px;">
  <span style="font-size: 36px; font-weight: bold; color: #006400;">100ERS</span>
</a>

<div class="wrap">
  <div class="card">
    <h1>100ers ‚Äî Functional Aging Score</h1>
    <p class="muted">This quick check estimates your <b>Functional Age</b> by looking at Strength, Mobility, Cognition, Mood, and Health. It‚Äôs not a label ‚Äî it‚Äôs a starting point to maintain (or improve) your independence.</p>
    <div class="progress"><div class="bar" id="progressBar"></div></div>

    <!-- STEP 1 -->
    <div id="step1" class="section">
      <h3>Step 1 ‚Äî About You</h3>
      <div class="grid">
        <div>
          <label for="age">Age (55+ for this version)</label><br/>
          <input id="age" type="number" min="20" max="120" required />
        </div>

        <!-- Height -->
        <div>
          <label>Height</label>
          <div class="row">
            <div id="heightSingleWrap" class="row" style="gap:10px;flex-wrap:nowrap;width:100%">
              <input id="hVal" type="number" min="80" max="250" placeholder="e.g., 170" style="max-width:200px" />
              <select id="hUnit" style="max-width:120px" aria-label="Height unit">
                <option value="cm">cm</option>
                <option value="ftin">ft + in</option>
              </select>
            </div>
            <div id="heightFtInWrap" class="row hide" style="gap:10px;flex-wrap:nowrap;width:100%">
              <input id="hFt" type="number" min="3" max="7" placeholder="ft" style="max-width:120px" />
              <input id="hIn" type="number" min="0" max="11" placeholder="in" style="max-width:120px" />
              <select id="hUnitFtIn" disabled style="max-width:120px"><option>ft + in</option></select>
            </div>
          </div>
          <div class="small muted">Tip: choose ‚Äúft + in‚Äù if you prefer imperial (e.g., 5 ft 7 in).</div>
        </div>

        <!-- Weight -->
        <div>
          <label>Weight</label>
          <div class="row">
            <input id="wVal" type="number" min="25" max="300" placeholder="e.g., 72" style="max-width:200px" />
            <select id="wUnit" style="max-width:120px" aria-label="Weight unit">
              <option value="kg">kg</option>
              <option value="lb">lb</option>
            </select>
          </div>
        </div>

        <!-- Gender (optional) -->
        <div>
          <label for="gender">Gender (optional)</label><br/>
          <select id="gender" style="max-width:200px">
            <option value="">Prefer not to say</option>
            <option value="female">Female</option>
            <option value="male">Male</option>
            <option value="other">Other / non-binary</option>
          </select>
        </div>
      </div>
      <div class="actions"><button id="toStep2">Next</button></div>
    </div>

    <!-- STEP 2: Questions -->
    <div id="step2" class="section hide">
      <h3>Step 2 ‚Äî Answer a Few Questions</h3>
      <div class="qwrap">
        <div class="qtitle" id="qTitle"></div>
        <div class="qhint" id="qHint"></div>
        <div class="pillrow" id="qOptions"></div>
      </div>
      <div class="actions">
        <button class="ghost" id="prevQ">Back</button>
        <button id="nextQ">Next</button>
      </div>
      <div class="small" id="qCounter"></div>
    </div>

    <!-- Under-55 notice -->
    <div id="under55" class="section hide">
      <h2>This version is for 55+ ‚Äî you‚Äôre early (which is great!)</h2>
      <p class="muted">For under‚Äë55s we‚Äôre launching a prevention‚Äëfocused score. Leave your details and we‚Äôll send the new quiz when it drops.</p>
      <div class="grid">
        <div><label for="uName">Your name</label><br/><input id="uName" type="text" /></div>
        <div><label for="uEmail">Email</label><br/><input id="uEmail" type="email" /></div>
      </div>
      <div class="actions">
        <button id="uNotify">Notify Me</button>
        <button class="ghost" id="uBack">Back</button>
      </div>
    </div>

    <!-- STEP 3: Contact -->
    <div id="step3" class="section hide">
      <h3>Step 3 ‚Äî Where can we send your score?</h3>
      <div class="grid">
        <div>
          <label for="name">Full Name</label><br/>
          <input id="name" type="text" required />
        </div>
        <div>
          <label for="email">Email</label><br/>
          <input id="email" type="email" required />
        </div>
        <div>
          <label for="city">City</label><br/>
          <input id="city" type="text" />
        </div>
        <div>
          <label for="facility">Facility (optional)</label><br/>
          <input id="facility" type="text" placeholder="e.g., Sunnyside Care Home" />
        </div>
        <div>
          <label class="small">
            <input id="consent" type="checkbox" checked />
            OK to email me my results and occasional 100ers updates.
          </label>
        </div>
      </div>
      <div class="actions">
        <button class="ghost" id="backToQ">Back</button>
        <button id="seeResults">See My Results</button>
      </div>
    </div>

    <!-- STEP 4: Results -->
    <div id="step4" class="section hide">
      <div class="result">
        <h2>Your Functional Aging Score</h2>
        <div class="kpi">
          <div class="box">
            <div class="small muted">Chronological age</div>
            <div id="kAge" style="font-weight:800;font-size:22px">‚Äì</div>
          </div>
          <div class="box">
            <div class="small muted">Functional age</div>
            <div id="kFAge" style="font-weight:800;font-size:22px">‚Äì</div>
          </div>
          <div class="box">
            <div class="small muted">Total score (0‚Äì100)</div>
            <div id="kScore" style="font-weight:800;font-size:22px">‚Äì</div>
          </div>
          <div class="box">
            <div class="small muted">BMI (impact)</div>
            <div id="kBMI" style="font-weight:800;font-size:22px">‚Äì</div>
          </div>
        </div>

        <p id="insight"></p>
        <div id="faExplainer" class="small"></div>

        <h4 style="margin-top:10px">Your domain breakdown</h4>
        <div class="bars">
          <div class="barrow"><div class="barlabel">Strength</div><div class="barfill"><span id="bStrength" style="width:0%"></span></div></div>
          <div class="barrow"><div class="barlabel">Mobility</div><div class="barfill"><span id="bMobility" style="width:0%"></span></div></div>
          <div class="barrow"><div class="barlabel">Cognition</div><div class="barfill"><span id="bCognition" style="width:0%"></span></div></div>
          <div class="barrow"><div class="barlabel">Mood</div><div class="barfill"><span id="bMood" style="width:0%"></span></div></div>
          <div class="barrow"><div class="barlabel">Health</div><div class="barfill"><span id="bHealth" style="width:0%"></span></div></div>
        </div>

        <div class="actions">
          <button id="btnBook">Book Expert Assessment</button>
          <a class="ghost" href="https://www.facebook.com/groups/1244710270315475" target="_blank" rel="noopener" style="text-decoration:none;display:inline-block;padding:12px 18px;border-radius:10px;border:1px solid var(--green);">Facebook Group</a>
          <button class="ghost" id="retake">Retake</button>
        </div>

        <div class="cta">
          <p><b>üéâ You‚Äôre now part of the 100ers movement.</b> Book an in‚Äëperson or online assessment (grip strength, gait speed, balance) to get a precise plan. We‚Äôll also send helpful tips via our newsletter ‚Äî and you can meet others in our private Facebook group.</p>
          <div class="small muted" style="margin-top:8px">In‚Äëperson available in White Rock / South Surrey.</div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Booking modal -->
<div class="modal" id="modalBook">
  <div class="dialog">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h4>Book Your Expert Assessment</h4>
      <span class="x" data-close>&times;</span>
    </div>
    <p class="small" style="margin:0 0 10px">
      Our expert will complete your assessment <b>online or in‚Äëperson</b> and create a <b>personal plan</b> for you. 
      Tell us how to reach you ‚Äî we‚Äôll call to book a convenient time.
    </p>
    <form name="book_assessment" method="POST" data-netlify="true">
      <input type="hidden" name="form-name" value="book_assessment" />
      <!-- auto-filled context -->
      <input type="hidden" name="context_total_score" id="ctx_total_score" />
      <input type="hidden" name="context_functional_age" id="ctx_functional_age" />
      <input type="hidden" name="context_bmi" id="ctx_bmi" />
      <input type="hidden" name="context_bmi_impact" id="ctx_bmi_impact" />
      <input type="hidden" name="context_domains" id="ctx_domains" />

      <div class="row2">
        <input name="name" id="book_name" placeholder="Full name" required />
        <input name="email" id="book_email" type="email" placeholder="Email" required />
      </div>
      <div class="row2">
        <input name="phone" id="book_phone" placeholder="Phone (optional)" />
        <input name="city" id="book_city" placeholder="City" />
      </div>

      <div class="row2">
        <select name="preference" id="book_pref" required>
          <option value="">Preferred assessment</option>
          <option value="online">Online</option>
          <option value="in-person">In‚Äëperson (White Rock / South Surrey)</option>
          <option value="either">Either is fine</option>
        </select>
        <select name="availability" id="book_avail">
          <option value="">Best time to reach you</option>
          <option>Morning</option><option>Afternoon</option><option>Evening</option>
        </select>
      </div>

      <textarea name="note" id="book_note" placeholder="Anything we should know (e.g., COPD, arthritis)" style="width:100%;min-height:110px;padding:12px;border:1px solid var(--border);border-radius:10px"></textarea>
      <div class="actions">
        <button type="submit">Request a Slot</button>
        <button class="ghost" type="button" data-close>Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ==== Questions (same as your working version) ==== */
const QUESTIONS = {
  strength: {
    "55-59":[
      {t:"How easy is it to lift a 20 lb (9 kg) bag of groceries?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
      {t:"How easily can you open a tight jar or bottle?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
      {t:"Do you feel muscle fatigue when carrying items for short distances?", lab:["Always","Often","Sometimes","Rarely","Never"]},
    ],
    "60-69":[
      {t:"How easy is it to lift a 15 lb (7 kg) bag of groceries?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
      {t:"How easily can you open a tight jar or bottle?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
      {t:"Do you feel muscle fatigue when carrying items for short distances?", lab:["Always","Often","Sometimes","Rarely","Never"]},
    ],
    "70-79":[
      {t:"How easy is it to lift a 10 lb (4.5 kg) bag of groceries?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
      {t:"How easily can you open a tight jar or bottle?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
      {t:"Do you feel muscle fatigue when carrying items for short distances?", lab:["Always","Often","Sometimes","Rarely","Never"]},
    ],
    "80-89":[
      {t:"How easy is it to lift a 7 lb (3 kg) bag without strain?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
      {t:"How easily can you open a tight jar or bottle?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
      {t:"Do you feel muscle fatigue when carrying items for short distances?", lab:["Always","Often","Sometimes","Rarely","Never"]},
    ],
    "90-99":[
      {t:"How easy is it to lift a 5 lb (2.3 kg) item without strain?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
      {t:"How easily can you open a tight jar or bottle?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
      {t:"Do you feel muscle fatigue when carrying items for short distances?", lab:["Always","Often","Sometimes","Rarely","Never"]},
    ],
    "100+":[
      {t:"How easy is it to lift a 3 lb (1.4 kg) item without strain?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
      {t:"How easily can you open a tight jar or bottle (with assistance if needed)?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
      {t:"Do you feel muscle fatigue when handling light items?", lab:["Always","Often","Sometimes","Rarely","Never"]},
    ]
  },
  mobility: {
    "55-59":[
      {t:"Can you stand on one foot for 30 seconds without support?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
      {t:"How steady do you feel walking on uneven ground (grass/sidewalks)?", lab:["Very Unsteady","Somewhat Unsteady","Moderately Steady","Quite Steady","Very Steady"]},
      {t:"Can you climb a flight of stairs without pausing or using the rail?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
    ],
    "60-69":[
      {t:"Can you stand on one foot for 10 seconds without support?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
      {t:"How steady do you feel walking on uneven ground (grass/sidewalks)?", lab:["Very Unsteady","Somewhat Unsteady","Moderately Steady","Quite Steady","Very Steady"]},
      {t:"Can you climb a flight of stairs without pausing or using the rail?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
    ],
    "70-79":[
      {t:"Can you stand on one foot for 10 seconds without support?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
      {t:"How steady do you feel walking on uneven ground (grass/sidewalks)?", lab:["Very Unsteady","Somewhat Unsteady","Moderately Steady","Quite Steady","Very Steady"]},
      {t:"Can you climb a flight of stairs without pausing or using the rail?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
    ],
    "80-89":[
      {t:"Can you stand on one foot for 5 seconds with light support (touching a wall)?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
      {t:"How steady do you feel walking on uneven ground (grass/sidewalks)?", lab:["Very Unsteady","Somewhat Unsteady","Moderately Steady","Quite Steady","Very Steady"]},
      {t:"Can you climb a flight of stairs with minimal pausing/support?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
    ],
    "90-99":[
      {t:"Can you stand on one foot for 3 seconds with support (chair/wall)?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
      {t:"How steady do you feel walking on flat ground?", lab:["Very Unsteady","Somewhat Unsteady","Moderately Steady","Quite Steady","Very Steady"]},
      {t:"Can you climb a few steps with support?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
    ],
    "100+":[
      {t:"Can you stand from a seated position with minimal support?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
      {t:"How steady do you feel during short walks indoors?", lab:["Very Unsteady","Somewhat Unsteady","Moderately Steady","Quite Steady","Very Steady"]},
      {t:"Can you transfer from bed to chair independently or with help?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
    ],
  },
  cognition:{ "All":[
    {t:"How often do you forget recent events or conversations?", lab:["Often","Occasionally","Sometimes","Rarely","Never"]},
    {t:"How easy is it to focus on tasks like reading or puzzles?", lab:["Very Difficult","Somewhat Difficult","Moderately Easy","Quite Easy","Very Easy"]},
    {t:"Is learning new things (technology/hobbies) challenging?", lab:["Very Challenging","Somewhat Challenging","Moderately Easy","Quite Easy","Not Challenging"]},
  ]},
  mood:{ "All":[
    {t:"How often do you feel connected to others?", lab:["Rarely","Occasionally","Sometimes","Often","Always"]},
    {t:"How well do you manage stress or low moods?", lab:["Poorly","Fairly","Average","Good","Very Well"]},
    {t:"How optimistic do you feel about your future?", lab:["Rarely","Occasionally","Sometimes","Often","Always"]},
  ]},
  health:{ "All":[
    {t:"Do chronic conditions limit daily activities?", lab:["A lot","Somewhat","Moderately","Slightly","Not at all"]},
    {t:"How well do you manage symptoms/medications?", lab:["Poorly","Fairly","Average","Good","Very Well"]},
    {t:"Does your health often affect energy or sleep?", lab:["Often","Sometimes","Occasionally","Rarely","Never"]},
  ]}
};

/* ==== Weights (unchanged) ==== */
const WEIGHTS = {
  "55-69": { strength:.25, mobility:.25, cognition:.20, mood:.15, health:.15 },
  "70-79": { strength:.25, mobility:.30, cognition:.20, mood:.125, health:.125 },
  "80-89": { strength:.20, mobility:.35, cognition:.20, mood:.125, health:.125 },
  "90-99": { strength:.15, mobility:.35, cognition:.25,  mood:.125, health:.125 },
  "100+":  { strength:.12, mobility:.35, cognition:.28,  mood:.125, health:.125 }
};

/* ==== Utils & scoring (BMI tiers + height guard) ==== */
const $ = s => document.querySelector(s);
const progressBarEl = $('#progressBar');
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
const sign = n => (n>0?`+${n}`:`${n}`);

function parseHeightToCm(hVal, hUnit, hFt, hIn){
  if (hUnit === 'cm'){
    const cm = parseFloat(hVal||0);
    if (!cm) return NaN;
    if (cm > 1 && cm < 3) return cm * 100;        // typed meters
    if (cm >= 3 && cm <= 8){                       // typed feet as decimal
      const ft = Math.floor(cm);
      let inches = Math.round((cm - ft) * 10);
      inches = clamp(inches, 0, 11);
      return ft*30.48 + inches*2.54;
    }
    if (cm < 120 || cm > 250) return NaN;
    return cm;
  } else {
    const ft = parseFloat(hFt||0), ins = parseFloat(hIn||0);
    if (!ft && ft!==0) return NaN;
    if (ins<0 || ins>11) return NaN;
    return ft*30.48 + ins*2.54;
  }
}
function weightKg(wVal, wUnit){
  const v = parseFloat(wVal||0);
  if (!v) return NaN;
  return (wUnit === 'lb') ? v*0.45359237 : v;
}
function bmiFrom(hcm, kg){
  if(!hcm || !kg) return NaN;
  return kg / Math.pow(hcm/100,2);
}
function bmiPenalty(bmi){
  if (bmi==null || isNaN(bmi)) return 0;
  if (bmi < 18.5) return -3;
  if (bmi < 27)   return 0;
  if (bmi < 30)   return -2;
  if (bmi < 35)   return -5;
  if (bmi < 38)   return -7;
  return -10;
}
function bmiCategory(bmi){
  if (bmi==null || isNaN(bmi)) return '‚Äî';
  if (bmi < 18.5) return 'Underweight';
  if (bmi < 27)   return 'Healthy';
  if (bmi < 30)   return 'Overweight';
  if (bmi < 35)   return 'Obesity I';
  if (bmi < 38)   return 'Obesity II';
  return 'Obesity III';
}
function decadeFromAge(age){
  if(age>=100) return "100+";
  if(age>=90)  return "90-99";
  if(age>=80)  return "80-89";
  if(age>=70)  return "70-79";
  if(age>=60)  return "60-69";
  return "55-59";
}
function weightBandFromAge(age){
  if(age>=100) return "100+";
  if(age>=90)  return "90-99";
  if(age>=80)  return "80-89";
  if(age>=70)  return "70-79";
  return "55-69";
}
function functionalAgeOptionB(age, totalScore){
  let base = Math.round((totalScore - 60) * 0.5);
  base = clamp(base, -18, 15);
  let factor = 1.0;
  if(age>=100) factor = 1.4;
  else if(age>=90) factor = 1.3;
  else if(age>=80) factor = 1.25;
  else if(age>=70) factor = 1.1;
  const yearsOff = clamp(Math.round(base * factor), -25, 15);
  return age - yearsOff;
}

/* ==== Google Sheet endpoint ==== */
const SHEET_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwiiaCCGDb9K2J2x53UGroL1vzcZK4oGn4yUh7vJUK8mH-td41Vlfb3DKZ1gZpKeqmj/exec';
function saveToSheet(payload){
  try{
    const blob = new Blob([JSON.stringify(payload)], { type: 'text/plain;charset=utf-8' });
    if (navigator.sendBeacon) { navigator.sendBeacon(SHEET_ENDPOINT, blob); return; }
    fetch(SHEET_ENDPOINT, { method:'POST', body:blob, mode:'no-cors', keepalive:true })
      .catch(err => console.warn('Sheet save failed:', err));
  }catch(e){ console.warn('Sheet save error:', e); }
}

/* ==== State ==== */
const state = {
  age:null, hVal:null, hUnit:'cm', hFt:null, hIn:null, wVal:null, wUnit:'kg', gender:"",
  qList:[], qIndex:0, answers:{}, name:"", email:"", city:"", facility:"", consent:true
};

/* ==== Build questions ==== */
function buildQuestionList(age){
  const decade = decadeFromAge(age);
  const list = [];
  QUESTIONS.strength[decade].forEach((q,i)=>list.push({key:`strength${i+1}`,domain:'strength',t:q.t,lab:q.lab}));
  QUESTIONS.mobility[decade].forEach((q,i)=>list.push({key:`mobility${i+1}`,domain:'mobility',t:q.t,lab:q.lab}));
  QUESTIONS.cognition.All.forEach((q,i)=>list.push({key:`cognition${i+1}`,domain:'cognition',t:q.t,lab:q.lab}));
  QUESTIONS.mood.All.forEach((q,i)=>list.push({key:`mood${i+1}`,domain:'mood',t:q.t,lab:q.lab}));
  QUESTIONS.health.All.forEach((q,i)=>list.push({key:`health${i+1}`,domain:'health',t:q.t,lab:q.lab}));
  return list;
}

/* ==== Render helpers ==== */
function setProgress(pct){ progressBarEl.style.width = `${pct}%`; }
function showStep(id){ ['#step1','#step2','#step3','#step4','#under55'].forEach(s=>$(s).classList.add('hide')); $(id).classList.remove('hide'); }
function renderCurrentQuestion(){
  const total=state.qList.length,i=state.qIndex,q=state.qList[i];
  $('#qTitle').textContent=q.t; $('#qHint').textContent="Select the option that best describes you.";
  const row=$('#qOptions'); row.innerHTML="";
  q.lab.forEach((label,idx)=>{
    const val=idx+1; const pill=document.createElement('span');
    pill.className='pill'; pill.dataset.val=String(val); pill.textContent=`${val} ‚Äî ${label}`;
    if(state.answers[q.key]===val) pill.dataset.selected="true";
    pill.addEventListener('click',()=>{row.querySelectorAll('.pill').forEach(p=>p.dataset.selected="false"); pill.dataset.selected="true"; state.answers[q.key]=val;});
    row.appendChild(pill);
  });
  $('#qCounter').textContent=`Question ${i+1} of ${total}`;
  setProgress(Math.min(95, Math.round((i/(total+3))*100)));
}

/* ==== Step 1 events ==== */
$('#hUnit').addEventListener('change',(e)=>{
  const useFtIn = e.target.value==='ftin';
  $('#heightSingleWrap').classList.toggle('hide',useFtIn);
  $('#heightFtInWrap').classList.toggle('hide',!useFtIn);
});
$('#toStep2').addEventListener('click', ()=>{
  const age=parseInt($('#age').value,10);
  if(!age || age<20 || age>120){ alert('Please enter a valid age (20‚Äì120).'); return; }
  if(age<55){ showStep('#under55'); setProgress(40); return; }

  const hUnit=$('#hUnit').value;
  const hVal=parseFloat($('#hVal').value);
  const hFt=parseFloat($('#hFt').value);
  const hIn=parseFloat($('#hIn').value||0);

  const hcm = parseHeightToCm(hVal, hUnit, hFt, hIn);
  if (isNaN(hcm)){ alert('Please enter a realistic height (e.g., 170 cm or 5 ft 7 in).'); return; }

  const wVal=parseFloat($('#wVal').value); const wUnit=$('#wUnit').value;
  const kg = weightKg(wVal, wUnit);
  if(!kg || isNaN(kg)){ alert('Please enter your weight.'); return; }

  state.age=age; state.hUnit=hUnit; state.hVal=isNaN(hVal)?null:hVal; state.hFt=isNaN(hFt)?null:hFt; state.hIn=isNaN(hIn)?null:hIn;
  state.wVal=wVal; state.wUnit=wUnit; state.gender = $('#gender').value || "";

  state.qList=buildQuestionList(age); state.qIndex=0; state.answers={};
  showStep('#step2'); renderCurrentQuestion();
});

/* Under-55 */
$('#uBack').addEventListener('click', ()=>{ showStep('#step1'); setProgress(0); });
$('#uNotify').addEventListener('click', ()=>{
  const n=$('#uName').value.trim(); const e=$('#uEmail').value.trim();
  if(!e){ alert('Please enter your email.'); return; }
  saveToSheet({ type:'under55_notify', name:n, email:e, timestamp:new Date().toISOString() });
  alert('Thanks! We‚Äôll let you know when the prevention version is live.');
  showStep('#step1'); setProgress(0);
});

/* Step 2 */
$('#nextQ').addEventListener('click', ()=>{
  const q=state.qList[state.qIndex]; if(!state.answers[q.key]){ alert('Please select an option to continue.'); return; }
  if(state.qIndex<state.qList.length-1){ state.qIndex++; renderCurrentQuestion(); }
  else { setProgress(96); showStep('#step3'); }
});
$('#prevQ').addEventListener('click', ()=>{ if(state.qIndex>0){ state.qIndex--; renderCurrentQuestion(); } else { showStep('#step1'); setProgress(0);} });

/* Step 3 -> Results */
$('#backToQ').addEventListener('click', ()=>{ showStep('#step2'); });
$('#seeResults').addEventListener('click', ()=>{
  state.name=$('#name').value.trim(); state.email=$('#email').value.trim(); state.city=$('#city').value.trim();
  state.facility=$('#facility').value.trim(); state.consent=$('#consent').checked;
  if(!state.name || !state.email){ alert('Please enter your name and email.'); return; }

  const age=state.age;
  const hUnit=$('#hUnit').value;
  const hVal=parseFloat($('#hVal').value);
  const hFt=parseFloat($('#hFt').value);
  const hIn=parseFloat($('#hIn').value||0);
  const hcm=parseHeightToCm(hVal, hUnit, hFt, hIn);

  const wVal=parseFloat($('#wVal').value); const wUnit=$('#wUnit').value;
  const kg=weightKg(wVal,wUnit);

  const bmi=bmiFrom(hcm,kg);
  const bmiAdj=bmiPenalty(bmi);
  const bmiCat=bmiCategory(bmi);

  const domains={strength:[],mobility:[],cognition:[],mood:[],health:[]};
  state.qList.forEach(q=>{ const v=state.answers[q.key]||0; domains[q.domain].push(v); });
  const domainScore=vals=>!vals.length?0:(vals.reduce((a,b)=>a+b,0)/vals.length)*4; // 0..20

  const sStrength=domainScore(domains.strength);
  const sMobility=domainScore(domains.mobility);
  const sCognition=domainScore(domains.cognition);
  const sMood=domainScore(domains.mood);
  const sHealth=domainScore(domains.health);

  const W=WEIGHTS[weightBandFromAge(age)];
  const weighted20 = sStrength*(W.strength||0)+sMobility*(W.mobility||0)+sCognition*(W.cognition||0)+sMood*(W.mood||0)+sHealth*(W.health||0);
  let adjustedScore = Math.round(weighted20*5 + bmiAdj);
  adjustedScore = clamp(adjustedScore,0,100);

  const fAge=Math.max(0,Math.round(functionalAgeOptionB(age,adjustedScore)));

  const decade=(age>=100?'100s':age>=90?'90s':age>=80?'80s':age>=70?'70s':age>=60?'60s':'late 50s');
  let insight='';
  if(adjustedScore>=80) insight=`For your ${decade}, this score is outstanding ‚Äî keep doing what works and consider our pilot to sustain your thriving vitality.`;
  else if(adjustedScore>=60) insight=`For your ${decade}, you‚Äôve built a solid base ‚Äî join the pilot to add strength, balance and confidence.`;
  else insight=`For your ${decade}, there‚Äôs room to grow ‚Äî a focused plan can restore strength, mobility and daily confidence.`;

  $('#kAge').textContent=age;
  $('#kFAge').textContent=fAge;
  $('#kScore').textContent=adjustedScore;
  $('#kBMI').textContent= (isNaN(bmi) ? '‚Äî' : `${bmi.toFixed(1)} (${sign(bmiAdj)})`);

  $('#insight').textContent=insight;

  // Bars (domain percentages)
  const pStrength = Math.round((sStrength/20)*100);
  const pMobility = Math.round((sMobility/20)*100);
  const pCognition= Math.round((sCognition/20)*100);
  const pMood     = Math.round((sMood/20)*100);
  const pHealth   = Math.round((sHealth/20)*100);

  $('#bStrength').style.width  = `${pStrength}%`;
  $('#bMobility').style.width  = `${pMobility}%`;
  $('#bCognition').style.width = `${pCognition}%`;
  $('#bMood').style.width      = `${pMood}%`;
  $('#bHealth').style.width    = `${pHealth}%`;

  // Lowest domain for "focus next"
  const domainPairs = [
    ['Strength', pStrength],
    ['Mobility', pMobility],
    ['Cognition', pCognition],
    ['Mood', pMood],
    ['Health', pHealth],
  ];
  domainPairs.sort((a,b)=>a[1]-b[1]);
  const lowestDomain = domainPairs[0][0];

  const explainerHTML = `
    <b>What this means</b><br/>
    You‚Äôre <b>${age}</b> with a <b>functional age of ${fAge}</b>. That means your current, day‚Äëto‚Äëday capacity
    looks like the <i>average</i> ${fAge}-year‚Äëold right now. It‚Äôs a practical benchmark ‚Äî not a diagnosis or lifespan prediction.<br/><br/>
    <b>Your drivers</b>:
    Strength ${pStrength}% ¬∑ Mobility ${pMobility}% ¬∑ Cognition ${pCognition}% ¬∑ Mood ${pMood}% ¬∑ Health ${pHealth}%<br/>
    <b>BMI</b>: ${isNaN(bmi)?'‚Äî':`${bmi.toFixed(1)} (${bmiCat}, impact ${sign(bmiAdj)})`}<br/>
    <b>Focus next</b>: ${lowestDomain}. Improve this area and re‚Äëcheck in 4‚Äì8 weeks to see your score move.
  `;
  document.getElementById('faExplainer').innerHTML = explainerHTML;

  setProgress(100); showStep('#step4');

  // Save to Google Sheet
  saveToSheet({
    type: 'fas_submission',
    timestamp: new Date().toISOString(),
    name: state.name, email: state.email, city: state.city, facility: state.facility,
    consent: state.consent, gender: state.gender,
    age: state.age, height_cm: hcm, weight_kg: kg, BMI: bmi, BMI_category: bmiCat, BMI_impact: bmiAdj,
    total_score: adjustedScore, functional_age: fAge,
    domain_scores: {strength:sStrength, mobility:sMobility, cognition:sCognition, mood:sMood, health:sHealth},
    weights_used: W,
    answers: state.answers
  });

  // Pre-fill booking modal
  document.getElementById('book_name').value = state.name || '';
  document.getElementById('book_email').value = state.email || '';
  document.getElementById('book_city').value = state.city || '';
  document.getElementById('ctx_total_score').value = adjustedScore;
  document.getElementById('ctx_functional_age').value = fAge;
  document.getElementById('ctx_bmi').value = isNaN(bmi)?'':bmi.toFixed(1);
  document.getElementById('ctx_bmi_impact').value = bmiAdj;
  document.getElementById('ctx_domains').value = JSON.stringify({
    strength:pStrength, mobility:pMobility, cognition:pCognition, mood:pMood, health:pHealth
  });
});

/* Retake */
$('#retake').addEventListener('click', ()=>{
  Object.assign(state,{age:null,hVal:null,hFt:null,hIn:null,hUnit:'cm',wVal:null,wUnit:'kg',gender:"",qList:[],qIndex:0,answers:{},name:"",email:"",city:"",facility:"",consent:true});
  ['age','hVal','hFt','hIn','wVal','name','email','city','facility'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
  $('#gender').value=''; $('#consent').checked=true; $('#hUnit').value='cm'; $('#wUnit').value='kg';
  $('#heightSingleWrap').classList.remove('hide'); $('#heightFtInWrap').classList.add('hide');
  setProgress(0); showStep('#step1');
});

/* Simple modal controls */
const modal = document.getElementById('modalBook');
document.getElementById('btnBook').addEventListener('click', ()=> modal.classList.add('show'));
modal.addEventListener('click', (e)=>{
  if(e.target.classList.contains('modal') || e.target.hasAttribute('data-close')) modal.classList.remove('show');
});

/* Init */
setProgress(0);
</script>
</body>
</html>
</html>